var wrap=require("wordwrap"),align={right:require("right-align"),center:require("center-align")},top=0,right=1,bottom=2,left=3;function UI(opts){this.width=opts.width;this.wrap=opts.wrap;this.rows=[]}UI.prototype.span=function(){var cols=this.div.apply(this,arguments);cols.span=true};UI.prototype.div=function(){if(arguments.length===0)this.div("");if(this.wrap&&this._shouldApplyLayoutDSL.apply(this,arguments)){return this._applyLayoutDSL(arguments[0])}var cols=[];for(var i=0,arg;(arg=arguments[i])!==undefined;i++){if(typeof arg==="string")cols.push(this._colFromString(arg));else cols.push(arg)}this.rows.push(cols);return cols};UI.prototype._shouldApplyLayoutDSL=function(){return arguments.length===1&&typeof arguments[0]==="string"&&/[\t\n]/.test(arguments[0])};UI.prototype._applyLayoutDSL=function(str){var _this=this,rows=str.split("\n"),leftColumnWidth=0;rows.forEach(function(row){var columns=row.split("\t");if(columns.length>1&&columns[0].length>leftColumnWidth){leftColumnWidth=Math.min(Math.floor(_this.width*.5),columns[0].length)}});rows.forEach(function(row){var columns=row.split("\t");_this.div.apply(_this,columns.map(function(r,i){return{text:r.trim(),padding:[0,r.match(/\s*$/)[0].length,0,r.match(/^\s*/)[0].length],width:i===0&&columns.length>1?leftColumnWidth:undefined}}))});return this.rows[this.rows.length-1]};UI.prototype._colFromString=function(str){return{text:str}};UI.prototype.toString=function(){var _this=this,lines=[];_this.rows.forEach(function(row,i){_this.rowToString(row,lines)});lines=lines.filter(function(line){return!line.hidden});return lines.map(function(line){return line.text}).join("\n")};UI.prototype.rowToString=function(row,lines){var _this=this,paddingLeft,rrows=this._rasterize(row),str="",ts,width,wrapWidth;rrows.forEach(function(rrow,r){str="";rrow.forEach(function(col,c){ts="";width=row[c].width;wrapWidth=_this._negatePadding(row[c]);for(var i=0;i<Math.max(wrapWidth,col.length);i++){ts+=col.charAt(i)||" "}if(row[c].align&&row[c].align!=="left"&&_this.wrap){ts=align[row[c].align](ts.trim()+"\n"+new Array(wrapWidth+1).join(" ")).split("\n")[0];if(ts.length<wrapWidth)ts+=new Array(width-ts.length).join(" ")}paddingLeft=(row[c].padding||[0,0,0,0])[left];if(paddingLeft)str+=new Array(row[c].padding[left]+1).join(" ");str+=ts;if(row[c].padding&&row[c].padding[right])str+=new Array(row[c].padding[right]+1).join(" ");if(r===0&&lines.length>0){str=_this._renderInline(str,lines[lines.length-1],paddingLeft)}});lines.push({text:str.replace(/ +$/,""),span:row.span})});return lines};UI.prototype._renderInline=function(source,previousLine,paddingLeft){var target=previousLine.text,str="";if(!previousLine.span)return source;if(!this.wrap){previousLine.hidden=true;return target+source}for(var i=0,tc,sc;i<Math.max(source.length,target.length);i++){tc=target.charAt(i)||" ";sc=source.charAt(i)||" ";if(tc!==" "&&sc!==" ")return source;if(sc!==" "&&i<paddingLeft+target.length)return source;if(tc===" ")str+=sc;else str+=tc}previousLine.hidden=true;return str};UI.prototype._rasterize=function(row){var _this=this,i,rrow,rrows=[],widths=this._columnWidths(row),wrapped;row.forEach(function(col,c){col.width=widths[c];if(_this.wrap)wrapped=wrap.hard(_this._negatePadding(col))(col.text).split("\n");else wrapped=col.text.split("\n");if(col.padding){for(i=0;i<(col.padding[top]||0);i++)wrapped.unshift("");for(i=0;i<(col.padding[bottom]||0);i++)wrapped.push("")}wrapped.forEach(function(str,r){if(!rrows[r])rrows.push([]);rrow=rrows[r];for(var i=0;i<c;i++){if(rrow[i]===undefined)rrow.push("")}rrow.push(str)})});return rrows};UI.prototype._negatePadding=function(col){var wrapWidth=col.width;if(col.padding)wrapWidth-=(col.padding[left]||0)+(col.padding[right]||0);return wrapWidth};UI.prototype._columnWidths=function(row){var _this=this,widths=[],unset=row.length,unsetWidth,remainingWidth=this.width;row.forEach(function(col,i){if(col.width){unset--;widths[i]=col.width;remainingWidth-=col.width}else{widths[i]=undefined}});if(unset)unsetWidth=Math.floor(remainingWidth/unset);widths.forEach(function(w,i){if(!_this.wrap)widths[i]=row[i].width||row[i].text.length;else if(w===undefined)widths[i]=Math.max(unsetWidth,_minWidth(row[i]))});return widths};function _minWidth(col){var padding=col.padding||[];return 1+(padding[left]||0)+(padding[right]||0)}module.exports=function(opts){opts=opts||{};return new UI({width:(opts||{}).width||80,wrap:typeof opts.wrap==="boolean"?opts.wrap:true})};