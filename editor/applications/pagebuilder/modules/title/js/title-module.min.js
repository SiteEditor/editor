(function( exports, $ ) {
    var api = sedApp.editor;
    api.initTitlesEditors = [];

    $( function() {
        $(".sed-pb-post-container-disable-editing").find('.sed-title').addClass('sed-title-no-editable').removeClass('sed-title');

        $(".sed-title").each( function(){
            api.initTitlesEditors.push( $(this).attr("sed_model_id") );
        });

        /*$(document).on('focusin', function(e) {
            if ($(e.target).closest(".mce-window").length) {
                e.stopImmediatePropagation();
            }
        });*/

        var _mceAddEditor = function( elId ){
            tinymce.execCommand( 'mceAddEditor', false, elId );
            api.initTitlesEditors.push( elId );
        };

        $(".sed-title").livequery(function(){

            var elId = $(this).attr("sed_model_id") ,
                index = $.inArray( elId , api.initTitlesEditors ) ,
                proccessing = false;

            if( index != -1 ){
                tinymce.execCommand( 'mceRemoveEditor', false, elId );
                api.initTitlesEditors.splice( index , 1 );
            }

            /*if( $(this).prop("tagName").toLowerCase() == "a" ){
                $(this).removeAttr("href");
            }else{
                $(this).parents().each(function(){
                    if( $(this).prop("tagName").toLowerCase() == "a" ){
                        $(this).removeAttr("href");
                        return false;
                    }
                });
            }  */

            var attrs = api.contentBuilder.getAttrs( elId );

            if( !_.isUndefined( attrs ) && !_.isUndefined( attrs.toolbar1 ) )
                $( '[sed_model_id="' + elId + '"]' ).data("toolbar1" , attrs.toolbar1 );

            if( !_.isUndefined( attrs ) && !_.isUndefined( attrs.toolbar2 ) )
                $( '[sed_model_id="' + elId + '"]' ).data("toolbar2" , attrs.toolbar2 );

                                                  //mouseout
            $(this).on( "mouseover mousemove mouseenter mouseout mouseup" , function(){

                if(api.appPreview.mode == "on")
                    return ;

                if( $.inArray( elId , api.initTitlesEditors ) == -1 ){
                    proccessing = true;
                    _mceAddEditor( elId );
                    proccessing = false;
                }

            });


            $(this).click(function(e){


                if(api.appPreview.mode == "on")
                    return ;

                e.preventDefault();
                e.stopImmediatePropagation(); //e.stopPropagation();

                var _isInit = function(){
                    if( $.inArray( elId , api.initTitlesEditors ) == -1 ){
                        if( proccessing === true )
                            setTimeout( _isInit , 5);
                        else{
                            _mceAddEditor( elId );
                            tinymce.execCommand( 'mceFocus' , false , elId );
                        }

                    }else
                        tinymce.execCommand( 'mceFocus' , false , elId );
                };

                if( $.inArray( elId , api.initTitlesEditors ) == -1 )
                    _isInit();

            });

        });

        api.siteIframe.textEditable( ".sed-title" , "title" );

    });


}(sedApp, jQuery));